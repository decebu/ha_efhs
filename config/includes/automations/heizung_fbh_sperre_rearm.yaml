# ─────────────────────────────
# FBH Sperre Auto-Rearm (nur 3 Bäder: UG/EG/OG)
# Sperre: 1 = gesperrt, 0 = freigegeben
# Timer je Bad über input_number einstellbar (Default 60 min)
# ─────────────────────────────

- id: heizung_ug_bad_fbh_sperre_rearm
  alias: "UG Bad FBH: Sperre nach Timer wieder setzen"
  mode: restart
  trigger:
    - platform: state
      entity_id: switch.ug_bad_sperre_fbh
      to: "off"
    - platform: state
      entity_id: switch.ug_bad_sperre_fbh
      to: "on"
    - platform: homeassistant
      event: start
  variables:
    runtime_min: "{{ states('input_number.fbh_sperre_rearm_minutes_ug_bad') | int(60) }}"
    runtime_sec: "{{ (runtime_min * 60) | int }}"
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ trigger.platform == 'state' and trigger.to_state.state == 'off' }}"
          sequence:
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.ug_bad_fbh_sperre_started
              data:
                datetime: "{{ now().isoformat() }}"
            - delay:
                seconds: "{{ runtime_sec }}"
            - condition: state
              entity_id: switch.ug_bad_sperre_fbh
              state: "off"
            - service: switch.turn_on
              target:
                entity_id: switch.ug_bad_sperre_fbh

        - conditions:
            - condition: template
              value_template: "{{ trigger.platform == 'state' and trigger.to_state.state == 'on' }}"
          sequence:
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.ug_bad_fbh_sperre_started
              data:
                datetime: "1970-01-01T00:00:00"

        - conditions:
            - condition: template
              value_template: "{{ trigger.platform == 'homeassistant' }}"
          sequence:
            - condition: state
              entity_id: switch.ug_bad_sperre_fbh
              state: "off"
            - variables:
                started_ts: "{{ as_timestamp(states('input_datetime.ug_bad_fbh_sperre_started'), 0) }}"
                elapsed: "{{ as_timestamp(now()) - started_ts }}"
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ started_ts > 0 and elapsed >= runtime_sec }}"
                  sequence:
                    - service: switch.turn_on
                      target:
                        entity_id: switch.ug_bad_sperre_fbh
                - conditions:
                    - condition: template
                      value_template: "{{ started_ts > 0 and elapsed < runtime_sec }}"
                  sequence:
                    - delay:
                        seconds: "{{ (runtime_sec - elapsed) | int }}"
                    - condition: state
                      entity_id: switch.ug_bad_sperre_fbh
                      state: "off"
                    - service: switch.turn_on
                      target:
                        entity_id: switch.ug_bad_sperre_fbh

- id: heizung_eg_bad_fbh_sperre_rearm
  alias: "EG Bad FBH: Sperre nach Timer wieder setzen"
  mode: restart
  trigger:
    - platform: state
      entity_id: switch.eg_bad_sperre_fbh
      to: "off"
    - platform: state
      entity_id: switch.eg_bad_sperre_fbh
      to: "on"
    - platform: homeassistant
      event: start
  variables:
    runtime_min: "{{ states('input_number.fbh_sperre_rearm_minutes_eg_bad') | int(60) }}"
    runtime_sec: "{{ (runtime_min * 60) | int }}"
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ trigger.platform == 'state' and trigger.to_state.state == 'off' }}"
          sequence:
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.eg_bad_fbh_sperre_started
              data:
                datetime: "{{ now().isoformat() }}"
            - delay:
                seconds: "{{ runtime_sec }}"
            - condition: state
              entity_id: switch.eg_bad_sperre_fbh
              state: "off"
            - service: switch.turn_on
              target:
                entity_id: switch.eg_bad_sperre_fbh

        - conditions:
            - condition: template
              value_template: "{{ trigger.platform == 'state' and trigger.to_state.state == 'on' }}"
          sequence:
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.eg_bad_fbh_sperre_started
              data:
                datetime: "1970-01-01T00:00:00"

        - conditions:
            - condition: template
              value_template: "{{ trigger.platform == 'homeassistant' }}"
          sequence:
            - condition: state
              entity_id: switch.eg_bad_sperre_fbh
              state: "off"
            - variables:
                started_ts: "{{ as_timestamp(states('input_datetime.eg_bad_fbh_sperre_started'), 0) }}"
                elapsed: "{{ as_timestamp(now()) - started_ts }}"
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ started_ts > 0 and elapsed >= runtime_sec }}"
                  sequence:
                    - service: switch.turn_on
                      target:
                        entity_id: switch.eg_bad_sperre_fbh
                - conditions:
                    - condition: template
                      value_template: "{{ started_ts > 0 and elapsed < runtime_sec }}"
                  sequence:
                    - delay:
                        seconds: "{{ (runtime_sec - elapsed) | int }}"
                    - condition: state
                      entity_id: switch.eg_bad_sperre_fbh
                      state: "off"
                    - service: switch.turn_on
                      target:
                        entity_id: switch.eg_bad_sperre_fbh

- id: heizung_og_bad_fbh_sperre_rearm
  alias: "OG Bad FBH: Sperre nach Timer wieder setzen"
  mode: restart
  trigger:
    - platform: state
      entity_id: switch.og_bad_sperre_fbh
      to: "off"
    - platform: state
      entity_id: switch.og_bad_sperre_fbh
      to: "on"
    - platform: homeassistant
      event: start
  variables:
    runtime_min: "{{ states('input_number.fbh_sperre_rearm_minutes_og_bad') | int(60) }}"
    runtime_sec: "{{ (runtime_min * 60) | int }}"
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ trigger.platform == 'state' and trigger.to_state.state == 'off' }}"
          sequence:
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.og_bad_fbh_sperre_started
              data:
                datetime: "{{ now().isoformat() }}"
            - delay:
                seconds: "{{ runtime_sec }}"
            - condition: state
              entity_id: switch.og_bad_sperre_fbh
              state: "off"
            - service: switch.turn_on
              target:
                entity_id: switch.og_bad_sperre_fbh

        - conditions:
            - condition: template
              value_template: "{{ trigger.platform == 'state' and trigger.to_state.state == 'on' }}"
          sequence:
            - service: input_datetime.set_datetime
              target:
                entity_id: input_datetime.og_bad_fbh_sperre_started
              data:
                datetime: "1970-01-01T00:00:00"

        - conditions:
            - condition: template
              value_template: "{{ trigger.platform == 'homeassistant' }}"
          sequence:
            - condition: state
              entity_id: switch.og_bad_sperre_fbh
              state: "off"
            - variables:
                started_ts: "{{ as_timestamp(states('input_datetime.og_bad_fbh_sperre_started'), 0) }}"
                elapsed: "{{ as_timestamp(now()) - started_ts }}"
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ started_ts > 0 and elapsed >= runtime_sec }}"
                  sequence:
                    - service: switch.turn_on
                      target:
                        entity_id: switch.og_bad_sperre_fbh
                - conditions:
                    - condition: template
                      value_template: "{{ started_ts > 0 and elapsed < runtime_sec }}"
                  sequence:
                    - delay:
                        seconds: "{{ (runtime_sec - elapsed) | int }}"
                    - condition: state
                      entity_id: switch.og_bad_sperre_fbh
                      state: "off"
                    - service: switch.turn_on
                      target:
                        entity_id: switch.og_bad_sperre_fbh
